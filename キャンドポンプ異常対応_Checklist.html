<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>「キャンドポンプ」異常対応チェックリスト</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        @media print {
            body > .container, .mt-3.container { display: none; }
            #print-area { display: block !important; padding: 20px; }
            .print-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
            .print-table th, .print-table td { border: 1px solid #ccc; padding: 8px; text-align: left; }
            .print-table th { background-color: #f2f2f2; }
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">「キャンドポンプ」異常対応チェックリスト</h1>
        <div id="checklist-container"></div>
    </div>
    <div class="mt-3 container">
        <button id="prev-btn" class="btn btn-secondary">戻る</button>
        <button id="next-btn" class="btn btn-primary">次へ</button>
        <button id="exit-btn" class="btn btn-danger">終了</button>
        <button id="print-btn" class="btn btn-info" style="display: none;">印刷</button>
    </div>
    <div id="print-area" style="display: none;"></div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js @1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        const checklistData = [
    { "phase": 1, "phase_title": "Phase 1: 異常検知・緊急停止", "type": "checklist_with_status", "category": "異常検知", "item": "ポンプが起動しない、またはモーターが回転しない", "item_id": "1_0", "linked_item_id": null },
    { "phase": 1, "phase_title": "Phase 1: 異常検知・緊急停止", "type": "checklist_with_status", "category": "異常検知", "item": "ポンプから液体が吐出されない、または吐出量が著しく少ない", "item_id": "1_1", "linked_item_id": null },
    { "phase": 1, "phase_title": "Phase 1: 異常検知・緊急停止", "type": "checklist_with_status", "category": "異常検知", "item": "運転中に「カラカラ」「ゴロゴロ」といった異音や、異常な振動がある", "item_id": "1_2", "linked_item_id": null },
    { "phase": 1, "phase_title": "Phase 1: 異常検知・緊急停止", "type": "checklist_with_status", "category": "異常検知", "item": "モーターケーシングの表面温度が異常に高い", "item_id": "1_3", "linked_item_id": null },
    { "phase": 1, "phase_title": "Phase 1: 異常検知・緊急停止", "type": "checklist_with_status", "category": "異常検知", "item": "モーターの過負荷保護装置（サーマルリレー）が作動している", "item_id": "1_4", "linked_item_id": null },
    { "phase": 1, "phase_title": "Phase 1: 異常検知・緊急停止", "type": "checklist_with_status", "category": "異常検知", "item": "ケーシングのガスケット部から液体が漏れている", "item_id": "1_5", "linked_item_id": null },
    { "phase": 1, "phase_title": "Phase 1: 異常検知・緊急停止", "type": "checklist_with_status", "category": "異常検知", "item": "（TRGモニタ付の場合）TRGの指示値が異常値（赤色域）を示している", "item_id": "1_6", "linked_item_id": null },
    { "phase": 1, "phase_title": "Phase 1: 異常検知・緊急停止", "type": "text_input", "category": "異常検知", "item": "その他", "item_id": "1_7", "linked_item_id": null },
    { "phase": 1, "phase_title": "Phase 1: 異常検知・緊急停止", "type": "checklist", "category": "緊急停止措置", "item": "ポンプの緊急停止ボタンを操作する。", "item_id": "1_8", "linked_item_id": null },
    { "phase": 1, "phase_title": "Phase 1: 異常検知・緊急停止", "type": "checklist", "category": "緊急停止措置", "item": "制御盤の主電源を遮断し、施錠（ロックアウト）および表示（タグアウト）を実施する。", "item_id": "1_9", "linked_item_id": null },
    { "phase": 1, "phase_title": "Phase 1: 異常検知・緊急停止", "type": "checklist", "category": "緊急停止措置", "item": "ポンプの吸込側および吐出側のバルブを完全に閉鎖する。", "item_id": "1_10", "linked_item_id": null },
    { "phase": 1, "phase_title": "Phase 1: 異常検知・緊急停止", "type": "checklist", "category": "緊急停止措置", "item": "高温または危険な液体の場合、周辺区域への立ち入りを禁止し、安全を確保する。", "item_id": "1_11", "linked_item_id": null },
    { "phase": 2, "phase_title": "Phase 2-1: 故障原因調査（使用部門）", "type": "checklist_with_status", "category": "運転状況確認", "item": "吸込側タンクの液面が不足している（空運転）", "item_id": "2_0", "linked_item_id": null },
    { "phase": 2, "phase_title": "Phase 2-1: 故障原因調査（使用部門）", "type": "checklist_with_status", "category": "運転状況確認", "item": "移送液にスラリー（固形物）が混入、または粘度が高い", "item_id": "2_1", "linked_item_id": null },
    { "phase": 2, "phase_title": "Phase 2-1: 故障原因調査（使用部門）", "type": "checklist_with_status", "category": "運転状況確認", "item": "吸込側・吐出側のバルブが全開になっていない", "item_id": "2_2", "linked_item_id": null },
    { "phase": 2, "phase_title": "Phase 2-1: 故障原因調査（使用部門）", "type": "checklist_with_status", "category": "外観・目視点検", "item": "吸込側配管ラインのストレーナー（フィルター）に詰まりがある", "item_id": "2_3", "linked_item_id": null },
    { "phase": 2, "phase_title": "Phase 2-1: 故障原因調査（使用部門）", "type": "checklist_with_status", "category": "外観・目視点検", "item": "ポンプ本体および配管のエア抜きが不十分", "item_id": "2_4", "linked_item_id": null },
    { "phase": 2, "phase_title": "Phase 2-1: 故障原因調査（使用部門）", "type": "checklist_with_status", "category": "外観・目視点検", "item": "（冷却ジャケット付の場合）冷却水の流量不足、または供給停止", "item_id": "2_5", "linked_item_id": null },
    { "phase": 2, "phase_title": "Phase 2-1: 故障原因調査（使用部門）", "type": "checklist_with_status", "category": "計器類確認", "item": "圧力計や流量計の指示値が異常", "item_id": "2_6", "linked_item_id": null },
    { "phase": 2, "phase_title": "Phase 2-1: 故障原因調査（使用部門）", "type": "checklist_with_status", "category": "計器類確認", "item": "電流計の指示値が定格を超えている", "item_id": "2_7", "linked_item_id": null },
    { "phase": 3, "phase_title": "Phase 3-1: 対策実施（使用部門）", "type": "checklist", "category": "運転状況確認", "item": "吸込側タンクに液体を補給する。", "item_id": "3_0", "linked_item_id": "2_0" },
    { "phase": 3, "phase_title": "Phase 3-1: 対策実施（使用部門）", "type": "checklist", "category": "運転状況確認", "item": "移送液の品質を確認し、前処理工程を見直す。", "item_id": "3_1", "linked_item_id": "2_1" },
    { "phase": 3, "phase_title": "Phase 3-1: 対策実施（使用部門）", "type": "checklist", "category": "運転状況確認", "item": "バルブを完全に開ける。", "item_id": "3_2", "linked_item_id": "2_2" },
    { "phase": 3, "phase_title": "Phase 3-1: 対策実施（使用部門）", "type": "checklist", "category": "外観・目視点検", "item": "ストレーナーを分解し、内部を清掃する。", "item_id": "3_3", "linked_item_id": "2_3" },
    { "phase": 3, "phase_title": "Phase 3-1: 対策実施（使用部門）", "type": "checklist", "category": "外観・目視点検", "item": "ポンプ本体および配管のエア抜きを再度、確実に行う。", "item_id": "3_4", "linked_item_id": "2_4" },
    { "phase": 3, "phase_title": "Phase 3-1: 対策実施（使用部門）", "type": "checklist", "category": "外観・目視点検", "item": "冷却水の供給を復旧させ、流量を再調整する。", "item_id": "3_5", "linked_item_id": "2_5" },
    { "phase": 3, "phase_title": "Phase 3-1: 対策実施（使用部門）", "type": "checklist", "category": "計器類確認", "item": "計器類確認", "item_id": "3_6", "linked_item_id": "2_6" },
    { "phase": 3, "phase_title": "Phase 3-1: 対策実施（使用部門）", "type": "checklist", "category": "計器類確認", "item": "（過電流の場合）運転を停止し、メンテナンス部門へ調査を依頼する。", "item_id": "3_7", "linked_item_id": "2_7" },
    { "phase": 4, "phase_title": "Phase 2-2: 故障原因調査（メンテナンス部門）", "type": "checklist_with_status", "category": "制御・電気系統", "item": "モーターへの供給電圧が不均一または低下している（欠相を含む）", "item_id": "4_0", "linked_item_id": null },
    { "phase": 4, "phase_title": "Phase 2-2: 故障原因調査（メンテナンス部門）", "type": "checklist_with_status", "category": "制御・電気系統", "item": "モーター巻線の絶縁抵抗が規定値以下", "item_id": "4_1", "linked_item_id": null },
    { "phase": 4, "phase_title": "Phase 2-2: 故障原因調査（メンテナンス部門）", "type": "checklist_with_status", "category": "制御・電気系統", "item": "過負荷保護装置（サーマルリレー）の設定値が不適切", "item_id": "4_2", "linked_item_id": null },
    { "phase": 4, "phase_title": "Phase 2-2: 故障原因調査（メンテナンス部門）", "type": "checklist_with_status", "category": "ポンプ本体・内部部品", "item": "前後ベアリング（スリーブベアリング）に異常な摩耗、傷、焼き付きがある", "item_id": "4_3", "linked_item_id": null },
    { "phase": 4, "phase_title": "Phase 2-2: 故障原因調査（メンテナンス部門）", "type": "checklist_with_status", "category": "ポンプ本体・内部部品", "item": "インペラ（羽根車）に摩耗、腐食、異物の詰まりがある", "item_id": "4_4", "linked_item_id": null },
    { "phase": 4, "phase_title": "Phase 2-2: 故障原因調査（メンテナンス部門）", "type": "checklist_with_status", "category": "ポンプ本体・内部部品", "item": "スラストワッシャー（スラスト軸受）に摩耗や傷がある", "item_id": "4_5", "linked_item_id": null },
    { "phase": 4, "phase_title": "Phase 2-2: 故障原因調査（メンテナンス部門）", "type": "checklist_with_status", "category": "ポンプ本体・内部部品", "item": "ロータキャンまたはステータキャンに変形、腐食、接触痕がある", "item_id": "4_6", "linked_item_id": null },
    { "phase": 4, "phase_title": "Phase 2-2: 故障原因調査（メンテナンス部門）", "type": "checklist_with_status", "category": "配管・システム", "item": "吸込配管の構造が原因で、空気だまりが発生している", "item_id": "4_7", "linked_item_id": null },
    { "phase": 4, "phase_title": "Phase 2-2: 故障原因調査（メンテナンス部門）", "type": "checklist_with_status", "category": "配管・システム", "item": "キャビテーション（液体の沸騰）が発生する運転条件になっている", "item_id": "4_8", "linked_item_id": null },
    { "phase": 5, "phase_title": "Phase 3-2: 対策実施（メンテナンス部門）", "type": "checklist", "category": "制御・電気系統", "item": "電源系統を点検し、電圧が不安定な原因を特定・修理する。", "item_id": "5_0", "linked_item_id": "4_0" },
    { "phase": 5, "phase_title": "Phase 3-2: 対策実施（メンテナンス部門）", "type": "checklist", "category": "制御・電気系統", "item": "絶縁不良の場合、モーターを交換する。", "item_id": "5_1", "linked_item_id": "4_1" },
    { "phase": 5, "phase_title": "Phase 3-2: 対策実施（メンテナンス部門）", "type": "checklist", "category": "制御・電気系統", "item": "過負荷保護装置の設定値を再設定する。", "item_id": "5_2", "linked_item_id": "4_2" },
    { "phase": 5, "phase_title": "Phase 3-2: 対策実施（メンテナンス部門）", "type": "checklist", "category": "ポンプ本体・内部部品", "item": "摩耗・損傷したベアリングを新品に交換する。", "item_id": "5_3", "linked_item_id": "4_3" },
    { "phase": 5, "phase_title": "Phase 3-2: 対策実施（メンテナンス部門）", "type": "checklist", "category": "ポンプ本体・内部部品", "item": "摩耗・損傷したインペラを交換し、詰まりを除去する。", "item_id": "5_4", "linked_item_id": "4_4" },
    { "phase": 5, "phase_title": "Phase 3-2: 対策実施（メンテナンス部門）", "type": "checklist", "category": "ポンプ本体・内部部品", "item": "摩耗したスラストワッシャーを新品に交換する。", "item_id": "5_5", "linked_item_id": "4_5" },
    { "phase": 5, "phase_title": "Phase 3-2: 対策実施（メンテナンス部門）", "type": "checklist", "category": "ポンプ本体・内部部品", "item": "変形・損傷したキャンを持つモーターを交換する。", "item_id": "5_6", "linked_item_id": "4_6" },
    { "phase": 5, "phase_title": "Phase 3-2: 対策実施（メンテナンス部門）", "type": "checklist", "category": "配管・システム", "item": "空気だまりが発生しないよう、配管経路の修正を検討・実施する。", "item_id": "5_7", "linked_item_id": "4_7" },
    { "phase": 5, "phase_title": "Phase 3-2: 対策実施（メンテナンス部門）", "type": "checklist", "category": "配管・システム", "item": "吸込配管径の見直しや、運転条件の変更を検討・実施する。", "item_id": "5_8", "linked_item_id": "4_8" },
    { "phase": 6, "phase_title": "Phase 4: 再起動前準備", "type": "checklist", "category": "復旧確認", "item": "交換した部品や修理箇所が、メーカーの仕様通りに正しく組付けられていることを確認する。", "item_id": "6_0", "linked_item_id": null },
    { "phase": 6, "phase_title": "Phase 4: 再起動前準備", "type": "checklist", "category": "復旧確認", "item": "ポンプ内部および吸込配管が、完全に液体で満たされていること（プライミング）を確認する。", "item_id": "6_1", "linked_item_id": null },
    { "phase": 6, "phase_title": "Phase 4: 再起動前準備", "type": "checklist", "category": "復旧確認", "item": "工具、部品、ウエスなどがポンプ本体や周辺に放置されていないことを確認する。", "item_id": "6_2", "linked_item_id": null },
    { "phase": 6, "phase_title": "Phase 4: 再起動前準備", "type": "checklist", "category": "安全確認", "item": "各部のボルトやフランジが、規定トルクで締め付けられていることを確認する。", "item_id": "6_3", "linked_item_id": null },
    { "phase": 6, "phase_title": "Phase 4: 再起動前準備", "type": "checklist", "category": "電源投入", "item": "関係者全員の安全を確認後、ロックアウト/タグアウトを正規の手順で解除する。", "item_id": "6_4", "linked_item_id": null },
    { "phase": 6, "phase_title": "Phase 4: 再起動前準備", "type": "checklist", "category": "電源投入", "item": "制御盤の主電源を投入し、エラー表示などが出ていないことを確認する。", "item_id": "6_5", "linked_item_id": null },
    { "phase": 6, "phase_title": "Phase 4: 再起動前準備", "type": "checklist", "category": "状態記録", "item": "故障内容、原因、対策、交換部品などを設備台帳や作業報告書に正確に記録する。", "item_id": "6_6", "linked_item_id": null },
    { "phase": 7, "phase_title": "Phase 5: 試運転・正規運転", "type": "checklist", "category": "寸動運転", "item": "モーターを瞬間的に回転させ、回転方向が正しいこと、および引っ掛かりや接触音がないことを確認する。", "item_id": "7_0", "linked_item_id": null },
    { "phase": 7, "phase_title": "Phase 5: 試運転・正規運転", "type": "checklist", "category": "無負荷運転", "item": "吐出側バルブを少し開けた状態で運転を開始し、再度エア抜きを行い、運転音が正常であることを確認する。", "item_id": "7_1", "linked_item_id": null },
    { "phase": 7, "phase_title": "Phase 5: 試運転・正規運転", "type": "checklist", "category": "段階的な速度上昇", "item": "吐出側バルブを徐々に開き、正規の流量・圧力まで負荷をかけていく過程で、振動や騒音に異常がないことを確認する。", "item_id": "7_2", "linked_item_id": null },
    { "phase": 7, "phase_title": "Phase 5: 試運転・正規運転", "type": "checklist", "category": "性能指標確認", "item": "正規の運転状態で、吐出圧力、流量、モーター電流値が規定値で安定していることを測定・確認する。", "item_id": "7_3", "linked_item_id": null },
    { "phase": 7, "phase_title": "Phase 5: 試運転・正規運転", "type": "checklist", "category": "性能指標確認", "item": "ポンプ本体モーター部の表面温度に異常な上昇がないことを測定・確認する。", "item_id": "7_4", "linked_item_id": null },
    { "phase": 7, "phase_title": "Phase 5: 試運転・正規運転", "type": "checklist", "category": "正規運転・監視", "item": "正規運転移行後、TRGモニタ（装備されている場合）の指示値が安定していることを確認する。", "item_id": "7_5", "linked_item_id": null },
    { "phase": 7, "phase_title": "Phase 5: 試運転・正規運転", "type": "checklist", "category": "正規運転・監視", "item": "運転開始後の一定時間（例：30分間）は重点的に監視し、異常の再発がないことを確認する。", "item_id": "7_6", "linked_item_id": null }
];
        const PRINT_TRIGGER_PHASE = 3;
        let currentPhase = 1;
        const maxPhase = Math.max(...checklistData.map(item => item.phase));
        let checklistState = {};

        function saveState() { 
            sessionStorage.setItem('checklistState', JSON.stringify(checklistState)); 
            sessionStorage.setItem('currentPhase', currentPhase);
        }

        function loadState() { 
            const savedState = sessionStorage.getItem('checklistState');
            const savedPhase = sessionStorage.getItem('currentPhase');
            if (savedState) checklistState = JSON.parse(savedState);
            if (savedPhase) currentPhase = parseInt(savedPhase, 10);
        }

        function renderCurrentPhase() {
            const container = $('#checklist-container'); container.empty();
            let itemsToShow = checklistData.filter(item => item.phase === currentPhase);
            const phaseTitle = itemsToShow.length > 0 ? itemsToShow[0].phase_title : `Phase ${currentPhase}`;
            if (currentPhase === 3 || currentPhase === 5) { itemsToShow = itemsToShow.filter(item => checklistState[item.linked_item_id] === 'problem'); }
            container.append(`<h2 class="phase-title">${phaseTitle}</h2>`);
            if (itemsToShow.length === 0 && (currentPhase === 3 || currentPhase === 5)) { container.append('<p>このフェーズで表示する項目はありません。前のフェーズで「問題あり」と選択された項目がありませんでした。</p>');
            } else { const groupedItems = itemsToShow.reduce((acc, item) => { (acc[item.category] = acc[item.category] || []).push(item); return acc; }, {}); for (const category in groupedItems) { container.append(`<h3 class="category-title">${category}</h3>`); groupedItems[category].forEach(item => container.append(createItemHtml(item))); } }
            updateButtonVisibility(); restoreState();
        }

        function createItemHtml(item) {
            const { type, item_id, item: itemText, phase } = item; let interactiveElementHtml = ''; const buttonStyle = 'style="min-width: 95px;"';
            if (type === 'checklist') { interactiveElementHtml = `<div class="btn-group-toggle" data-toggle="buttons"><label class="btn btn-outline-primary" ${buttonStyle} data-item-id="${item_id}" data-value="checked"><input type="checkbox" autocomplete="off"> 実施済み</label></div>`;
            } else if (type === 'checklist_with_status') { if (phase === 1) { interactiveElementHtml = `<div class="btn-group btn-group-toggle" data-toggle="buttons"><label class="btn btn-outline-success" ${buttonStyle} data-item-id="${item_id}" data-value="applicable"><input type="radio" name="options-${item_id}" autocomplete="off"> 該当</label><label class="btn btn-outline-danger" ${buttonStyle} data-item-id="${item_id}" data-value="not_applicable"><input type="radio" name="options-${item_id}" autocomplete="off"> 非該当</label></div>`; } else { interactiveElementHtml = `<div class="btn-group btn-group-toggle" data-toggle="buttons"><label class="btn btn-outline-success" ${buttonStyle} data-item-id="${item_id}" data-value="ok"><input type="radio" name="options-${item_id}" autocomplete="off"> 問題なし</label><label class="btn btn-outline-danger" ${buttonStyle} data-item-id="${item_id}" data-value="problem"><input type="radio" name="options-${item_id}" autocomplete="off"> 問題あり</label></div>`; } 
            } else if (type === 'checklist_with_na') { interactiveElementHtml = `<div class="btn-group btn-group-toggle" data-toggle="buttons"><label class="btn btn-outline-primary" ${buttonStyle} data-item-id="${item_id}" data-value="checked"><input type="radio" name="options-${item_id}" autocomplete="off"> 実施済み</label><label class="btn btn-outline-secondary" ${buttonStyle} data-item-id="${item_id}" data-value="not_applicable"><input type="radio" name="options-${item_id}" autocomplete="off"> 非該当</label></div>`;
            } else if (type === 'text_input') { const labelHtml = `<label class="col-auto col-form-label pr-3">${itemText}</label>`; const textareaHtml = `<div class="col pl-0"><textarea class="form-control" rows="2" data-item-id="${item_id}" placeholder="具体的な内容を入力"></textarea></div>`; return `<div class="form-group row no-gutters align-items-center">${labelHtml}${textareaHtml}</div>`; }
            return `<div class="checklist-item-row"><label class="form-check-label item-label">${itemText}</label>${interactiveElementHtml}</div>`;
        }
        
        function restoreState() { for (const itemId in checklistState) { const value = checklistState[itemId]; $(`label[data-item-id="${itemId}"][data-value="${value}"]`).addClass('active').find('input').prop('checked', true); $(`textarea[data-item-id="${itemId}"]`).val(value); } validateCurrentPhaseCompletion(); updatePrintButtonVisibility(); }
        function validateCurrentPhaseCompletion() { const requiredItems = checklistData.filter(item => { if (item.phase !== currentPhase || item.type === 'text_input') return false; return $(`[data-item-id="${item.item_id}"]`).length > 0; }); if (requiredItems.length === 0) { if (currentPhase < maxPhase) $('#next-btn').prop('disabled', false); return; } const allChecked = requiredItems.every(item => checklistState.hasOwnProperty(item.item_id)); $('#next-btn').prop('disabled', !allChecked); }
        
        function updatePrintButtonVisibility() {
            if (sessionStorage.getItem('printEnabled') !== 'true') {
                const requiredItems = checklistData.filter(item => { if (item.phase !== PRINT_TRIGGER_PHASE) return false; if (item.linked_item_id) { return checklistState[item.linked_item_id] === 'problem'; } return true; });
                const allChecked = requiredItems.every(item => checklistState.hasOwnProperty(item.item_id));
                if (requiredItems.length > 0 && allChecked) { sessionStorage.setItem('printEnabled', 'true'); }
            }
            if (sessionStorage.getItem('printEnabled') === 'true') { $('#print-btn').show(); } else { $('#print-btn').hide(); }
        }

        function updateButtonVisibility() { $('#prev-btn').toggle(currentPhase > 1); $('#next-btn').toggle(currentPhase < maxPhase); $('#next-btn').prop('disabled', true); }

        $(document).ready(function() {
            loadState(); renderCurrentPhase();
            $('#next-btn, #prev-btn').on('click', function() { if ($(this).is('#next-btn') && $(this).is(':disabled')) return; currentPhase += $(this).is('#next-btn') ? 1 : -1; saveState(); renderCurrentPhase(); });
            $('#exit-btn').on('click', () => { if (confirm('チェックリストを終了し、メインメニューに戻りますか？')) { sessionStorage.clear(); window.location.href = 'index.html'; } });
            
            $('#print-btn').on('click', function() {
                const printContainer = $('#print-area');
                let html = `<h1>「${document.title.replace('異常対応チェックリスト', '')}」実施結果</h1>`;
                const valueMap = { 'checked': '実施済み', 'applicable': '該当', 'not_applicable': '非該当', 'ok': '問題なし', 'problem': '問題あり' };
                const answeredPhaseNumbers = [...new Set(Object.keys(checklistState).map(itemId => checklistData.find(d => d.item_id === itemId)?.phase).filter(p => p).sort((a, b) => a - b))];

                answeredPhaseNumbers.forEach(phaseNum => {
                    const phaseItems = checklistData.filter(d => d.phase === phaseNum && checklistState.hasOwnProperty(d.item_id));
                    if (phaseItems.length > 0) {
                        const printableItems = phaseItems.filter(item => {
                            if (item.linked_item_id) { return checklistState[item.linked_item_id] === 'problem'; }
                            return true;
                        });
                        if (printableItems.length > 0) {
                            html += `<h2>${printableItems[0].phase_title}</h2><table class="print-table"><tr><th>項目</th><th>結果</th></tr>`;
                            printableItems.forEach(item => {
                                let result = checklistState[item.item_id];
                                let resultText = valueMap[result] || result;
                                let style = (result === 'problem') ? 'style="color: red;"' : '';
                                html += `<tr><td>${item.item}</td><td ${style}>${resultText}</td></tr>`;
                            });
                            html += '</table>';
                        }
                    }
                });
                printContainer.html(html);
                window.print();
            });

            $('#checklist-container').on('click', 'label.btn', function() { const label = $(this), itemId = label.data('item-id'); setTimeout(() => { if (label.find('input').is('[type=radio]')) { const activeValue = label.closest('.btn-group-toggle').find('.active').data('value'); if(activeValue) checklistState[itemId] = activeValue; else delete checklistState[itemId]; } else { if (label.hasClass('active')) checklistState[itemId] = label.data('value'); else delete checklistState[itemId]; } saveState(); validateCurrentPhaseCompletion(); updatePrintButtonVisibility(); }, 0); });
            $('#checklist-container').on('input', 'textarea', function() { const input = $(this), itemId = input.data('item-id'), value = input.val(); if (value) checklistState[itemId] = value; else delete checklistState[itemId]; saveState(); });
        });
    </script>
</body>
</html>
