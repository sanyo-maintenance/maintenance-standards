<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>「インバーター」異常対応チェックリスト</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        @media print {
            body > .container, .mt-3.container { display: none; }
            #print-area { display: block !important; }
            .print-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
            .print-table th, .print-table td { border: 1px solid #ccc; padding: 8px; text-align: left; }
            .print-table th { background-color: #f2f2f2; }
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">「インバーター」異常対応チェックリスト</h1>
        <div id="checklist-container"></div>
    </div>
    <div class="mt-3 container">
        <button id="prev-btn" class="btn btn-secondary">戻る</button>
        <button id="next-btn" class="btn btn-primary">次へ</button>
        <button id="exit-btn" class="btn btn-danger">終了</button>
        <button id="print-btn" class="btn btn-info" style="display: none;">印刷</button>
    </div>
    <div id="print-area" style="display: none; padding: 20px;"></div>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        const checklistData = [
            { "phase": 1, "phase_title": "Phase 1: 異常検知・緊急停止", "type": "checklist_with_status", "category": "異常検知", "item": "操作パネルにエラーコード（OC, OV, UV, OH等）が表示され、モーターがトリップ（停止）した", "item_id": "1_0", "linked_item_id": null },
            { "phase": 1, "phase_title": "Phase 1: 異常検知・緊急停止", "type": "checklist_with_status", "category": "異常検知", "item": "モーターが起動しない、または設定された回転数まで上昇しない", "item_id": "1_1", "linked_item_id": null },
            { "phase": 1, "phase_title": "Phase 1: 異常検知・緊急停止", "type": "checklist_with_status", "category": "異常検知", "item": "モーターの回転が不安定（速度が変動する、ハンチングする）", "item_id": "1_2", "linked_item_id": null },
            { "phase": 1, "phase_title": "Phase 1: 異常検知・緊急停止", "type": "checklist_with_status", "category": "異常検知", "item": "モーターまたはインバーター本体から異音、異常な振動が発生している", "item_id": "1_3", "linked_item_id": null },
            { "phase": 1, "phase_title": "Phase 1: 異常検知・緊急停止", "type": "checklist_with_status", "category": "異常検知", "item": "インバーター本体や抵抗器から異臭（焦げ臭い匂い）、発煙がある", "item_id": "1_4", "linked_item_id": null },
            { "phase": 1, "phase_title": "Phase 1: 異常検知・緊急停止", "type": "checklist_with_status", "category": "異常検知", "item": "インバーターの冷却ファンが停止している、または異常な音を立てている", "item_id": "1_5", "linked_item_id": null },
            { "phase": 1, "phase_title": "Phase 1: 異常検知・緊急停止", "type": "checklist_with_status", "category": "異常検知", "item": "インバーターの一次側（入力側）のブレーカーやヒューズが作動した", "item_id": "1_6", "linked_item_id": null },
            { "phase": 1, "phase_title": "Phase 1: 異常検知・緊急停止", "type": "text_input", "category": "異常検知", "item": "その他", "item_id": "1_7", "linked_item_id": null },
            { "phase": 1, "phase_title": "Phase 1: 異常検知・緊急停止", "type": "checklist", "category": "緊急停止措置", "item": "インバーターの運転を停止させた（STOPボタン、外部停止信号）", "item_id": "1_8", "linked_item_id": null },
            { "phase": 1, "phase_title": "Phase 1: 異常検知・緊急停止", "type": "checklist", "category": "緊急停止措置", "item": "インバーターの主回路電源（一次側ブレーカー）を遮断した", "item_id": "1_9", "linked_item_id": null },
            { "phase": 1, "phase_title": "Phase 1: 異常検知・緊急停止", "type": "checklist", "category": "緊急停止措置", "item": "電源遮断後、インバーターのチャージランプが完全に消灯するまで待機した（感電防止）", "item_id": "1_10", "linked_item_id": null },
            { "phase": 1, "phase_title": "Phase 1: 異常検知・緊急停止", "type": "checklist", "category": "緊急停止措置", "item": "遮断したブレーカーにロックアウト/タグアウトを実施した", "item_id": "1_11", "linked_item_id": null },
            { "phase": 1, "phase_title": "Phase 1: 異常検知・緊急停止", "type": "checklist", "category": "緊急停止措置", "item": "上長およびメンテナンス部門、関連部署へ異常発生を第一報連絡した", "item_id": "1_12", "linked_item_id": null },
            { "phase": 2, "phase_title": "Phase 2-1: 故障原因調査（使用部門）", "type": "checklist_with_status", "category": "エラーコード確認", "item": "操作パネルに表示されているエラーコード（例: \"OC1\", \"OV\", \"E.THM\"）は何か", "item_id": "2_0", "linked_item_id": null },
            { "phase": 2, "phase_title": "Phase 2-1: 故障原因調査（使用部門）", "type": "checklist_with_status", "category": "エラーコード確認", "item": "エラー発生時の運転周波数、出力電流、出力電圧のモニター値はいくつか", "item_id": "2_1", "linked_item_id": null },
            { "phase": 2, "phase_title": "Phase 2-1: 故障原因調査（使用部門）", "type": "checklist_with_status", "category": "運転状況確認", "item": "異常発生の直前に、運転周波数や加減速時間などのパラメータを変更しなかったか", "item_id": "2_2", "linked_item_id": null },
            { "phase": 2, "phase_title": "Phase 2-1: 故障原因調査（使用部門）", "type": "checklist_with_status", "category": "運転状況確認", "item": "負荷（ポンプ、ファン、コンベア等）の状態で急激な変化（噛み込み、詰まり、バルブの急閉等）はなかったか", "item_id": "2_3", "linked_item_id": null },
            { "phase": 2, "phase_title": "Phase 2-1: 故障原因調査（使用部門）", "type": "checklist_with_status", "category": "外観・周辺環境確認", "item": "インバーターの通風孔（吸気口、排気口）が埃や異物で塞がれていないか", "item_id": "2_4", "linked_item_id": null },
            { "phase": 2, "phase_title": "Phase 2-1: 故障原因調査（使用部門）", "type": "checklist_with_status", "category": "外観・周辺環境確認", "item": "盤内の温度が異常に高くなっていないか（換気ファンの動作確認）", "item_id": "2_5", "linked_item_id": null },
            { "phase": 2, "phase_title": "Phase 2-1: 故障原因調査（使用部門）", "type": "checklist_with_status", "category": "外観・周辺環境確認", "item": "モーター側の負荷に、手で回せないほどの機械的なロックや固着はないか", "item_id": "2_6", "linked_item_id": null },
            { "phase": 2, "phase_title": "Phase 2-1: 故障原因調査（使用部門）", "type": "checklist_with_status", "category": "外観・周辺環境確認", "item": "インバーター本体や配線に、焼損、変色、部品（コンデンサ等）の膨張はないか", "item_id": "2_7", "linked_item_id": null },
            { "phase": 3, "phase_title": "Phase 3-1: 対策実施（使用部門）", "type": "checklist", "category": "エラーコード確認", "item": "エラーコードとその内容、モニター値を正確に記録し、メンテナンス部門へ報告する", "item_id": "3_0", "linked_item_id": "2_0" },
            { "phase": 3, "phase_title": "Phase 3-1: 対策実施（使用部門）", "type": "checklist", "category": "エラーコード確認", "item": "エラー履歴を写真撮影またはメモで保存する", "item_id": "3_1", "linked_item_id": "2_1" },
            { "phase": 3, "phase_title": "Phase 3-1: 対策実施（使用部門）", "type": "checklist", "category": "運転状況確認", "item": "変更したパラメータを、異常発生前の設定値に戻すことを検討・報告する", "item_id": "3_2", "linked_item_id": "2_2" },
            { "phase": 3, "phase_title": "Phase 3-1: 対策実施（使用部門）", "type": "checklist", "category": "運転状況確認", "item": "負荷側の異常（噛み込み、詰まり等）を取り除き、正常な状態に復旧させる", "item_id": "3_3", "linked_item_id": "2_3" },
            { "phase": 3, "phase_title": "Phase 3-1: 対策実施（使用部門）", "type": "checklist", "category": "外観・周辺環境確認", "item": "インバーターの通風孔およびフィルターを清掃し、通気を確保する", "item_id": "3_4", "linked_item_id": "2_4" },
            { "phase": 3, "phase_title": "Phase 3-1: 対策実施（使用部門）", "type": "checklist", "category": "外観・周辺環境確認", "item": "盤内の換気扇やクーラーの異常を修理または報告する", "item_id": "3_5", "linked_item_id": "2_5" },
            { "phase": 3, "phase_title": "Phase 3-1: 対策実施（使用部門）", "type": "checklist", "category": "外観・周辺環境確認", "item": "モーター側のロックや固着を解消する", "item_id": "3_6", "linked_item_id": "2_6" },
            { "phase": 3, "phase_title": "Phase 3-1: 対策実施（使用部門）", "type": "checklist", "category": "外観・周辺環境確認", "item": "外観上の異常箇所を具体的に報告する", "item_id": "3_7", "linked_item_id": "2_7" },
            { "phase": 4, "phase_title": "Phase 2-2: 故障原因調査（メンテナンス部門）", "type": "checklist_with_status", "category": "主回路系統", "item": "入力側（R/L1, S/L2, T/L3）の相間電圧は規定範囲内か。瞬時停電や相間アンバランスはなかったか", "item_id": "4_0", "linked_item_id": null },
            { "phase": 4, "phase_title": "Phase 2-2: 故障原因調査（メンテナンス部門）", "type": "checklist_with_status", "category": "主回路系統", "item": "出力側（U, V, W）の相間電圧は、周波数指令に応じてバランス良く出力されているか", "item_id": "4_1", "linked_item_id": null },
            { "phase": 4, "phase_title": "Phase 2-2: 故障原因調査（メンテナンス部門）", "type": "checklist_with_status", "category": "主回路系統", "item": "モーターケーブルおよびモーター巻線の絶縁抵抗は良好か（メガテスターで地絡を測定）", "item_id": "4_2", "linked_item_id": null },
            { "phase": 4, "phase_title": "Phase 2-2: 故障原因調査（メンテナンス部門）", "type": "checklist_with_status", "category": "主回路系統", "item": "コンバータ部（ダイオード）およびインバータ部（IGBT）の短絡・オープン故障はないか（テスターでチェック）", "item_id": "4_3", "linked_item_id": null },
            { "phase": 4, "phase_title": "Phase 2-2: 故障原因調査（メンテナンス部門）", "type": "checklist_with_status", "category": "主回路系統", "item": "主回路の平滑コンデンサに膨張、液漏れ、規定外の静電容量はないか", "item_id": "4_4", "linked_item_id": null },
            { "phase": 4, "phase_title": "Phase 2-2: 故障原因調査（メンテナンス部門）", "type": "checklist_with_status", "category": "制御回路・電源系統", "item": "制御電源の電圧は正常か。制御基板のヒューズは切れていないか", "item_id": "4_5", "linked_item_id": null },
            { "phase": 4, "phase_title": "Phase 2-2: 故障原因調査（メンテナンス部門）", "type": "checklist_with_status", "category": "制御回路・電源系統", "item": "外部からの運転指令信号（正転/逆転）、周波数設定信号（4-20mA, 0-10V等）は正常に入力されているか", "item_id": "4_6", "linked_item_id": null },
            { "phase": 4, "phase_title": "Phase 2-2: 故障原因調査（メンテナンス部門）", "type": "checklist_with_status", "category": "制御回路・電源系統", "item": "操作パネルと制御基板を接続するケーブルに、接触不良や断線はないか", "item_id": "4_7", "linked_item_id": null },
            { "phase": 4, "phase_title": "Phase 2-2: 故障原因調査（メンテナンス部門）", "type": "checklist_with_status", "category": "モーター・負荷系統", "item": "モーターの巻線抵抗は三相間で平衡が取れているか", "item_id": "4_8", "linked_item_id": null },
            { "phase": 4, "phase_title": "Phase 2-2: 故障原因調査（メンテナンス部門）", "type": "checklist_with_status", "category": "モーター・負荷系統", "item": "モーターのベアリングに異音や固着、過大なガタつきはないか", "item_id": "4_9", "linked_item_id": null },
            { "phase": 4, "phase_title": "Phase 2-2: 故障原因調査（メンテナンス部門）", "type": "checklist_with_status", "category": "モーター・負荷系統", "item": "減速機、カップリング、ベルト等の動力伝達部に破損や異常な抵抗はないか", "item_id": "4_10", "linked_item_id": null },
            { "phase": 4, "phase_title": "Phase 2-2: 故障原因調査（メンテナンス部門）", "type": "checklist_with_status", "category": "冷却系統", "item": "冷却ファンの羽根に破損はないか、手で回してスムーズに回転するか", "item_id": "4_11", "linked_item_id": null },
            { "phase": 4, "phase_title": "Phase 2-2: 故障原因調査（メンテナンス部門）", "type": "checklist_with_status", "category": "冷却系統", "item": "ヒートシンク（冷却フィン）に埃が詰まっていないか", "item_id": "4_12", "linked_item_id": null },
            { "phase": 5, "phase_title": "Phase 3-2: 対策実施（メンテナンス部門）", "type": "checklist", "category": "主回路系統", "item": "電源電圧の異常がある場合、電源系統（トランス、配線）を調査・改善する", "item_id": "5_0", "linked_item_id": "4_0" },
            { "phase": 5, "phase_title": "Phase 3-2: 対策実施（メンテナンス部門）", "type": "checklist", "category": "主回路系統", "item": "出力電圧のアンバランスや地絡がある場合、モーターケーブルまたはモーター本体を修理・交換する", "item_id": "5_1", "linked_item_id": "4_1" },
            { "phase": 5, "phase_title": "Phase 3-2: 対策実施（メンテナンス部門）", "type": "checklist", "category": "主回路系統", "item": "絶縁不良のモーターを交換する", "item_id": "5_2", "linked_item_id": "4_2" },
            { "phase": 5, "phase_title": "Phase 3-2: 対策実施（メンテナンス部門）", "type": "checklist", "category": "主回路系統", "item": "故障したパワーモジュール（IGBT等）や制御基板を交換する", "item_id": "5_3", "linked_item_id": "4_3" },
            { "phase": 5, "phase_title": "Phase 3-2: 対策実施（メンテナンス部門）", "type": "checklist", "category": "主回路系統", "item": "劣化した平滑コンデンサを交換する", "item_id": "5_4", "linked_item_id": "4_4" },
            { "phase": 5, "phase_title": "Phase 3-2: 対策実施（メンテナンス部門）", "type": "checklist", "category": "制御回路・電源系統", "item": "故障した制御電源ユニットや切れたヒューズを交換する", "item_id": "5_5", "linked_item_id": "4_5" },
            { "phase": 5, "phase_title": "Phase 3-2: 対策実施（メンテナンス部門）", "type": "checklist", "category": "制御回路・電源系統", "item": "指令信号系統の配線不良を修正、または信号源（PLC、計装機器）の異常を修理する", "item_id": "5_6", "linked_item_id": "4_6" },
            { "phase": 5, "phase_title": "Phase 3-2: 対策実施（メンテナンス部門）", "type": "checklist", "category": "制御回路・電源系統", "item": "接触不良のあるケーブルやコネクタを修理または交換する", "item_id": "5_7", "linked_item_id": "4_7" },
            { "phase": 5, "phase_title": "Phase 3-2: 対策実施（メンテナンス部門）", "type": "checklist", "category": "モーター・負荷系統", "item": "巻線抵抗に異常があるモーターを交換する", "item_id": "5_8", "linked_item_id": "4_8" },
            { "phase": 5, "phase_title": "Phase 3-2: 対策実施（メンテナンス部門）", "type": "checklist", "category": "モーター・負荷系統", "item": "異音や固着のあるモーターのベアリングを交換する", "item_id": "5_9", "linked_item_id": "4_9" },
            { "phase": 5, "phase_title": "Phase 3-2: 対策実施（メンテナンス部門）", "type": "checklist", "category": "モーター・負荷系統", "item": "負荷側の機械を修理・調整し、過負荷の原因を除去する", "item_id": "5_10", "linked_item_id": "4_10" },
            { "phase": 5, "phase_title": "Phase 3-2: 対策実施（メンテナンス部門）", "type": "checklist", "category": "冷却系統", "item": "故障した冷却ファンを交換する", "item_id": "5_11", "linked_item_id": "4_11" },
            { "phase": 5, "phase_title": "Phase 3-2: 対策実施（メンテナンス部門）", "type": "checklist", "category": "冷却系統", "item": "ヒートシンクをエアブロー等で清掃する", "item_id": "5_12", "linked_item_id": "4_12" },
            { "phase": 6, "phase_title": "Phase 4: 再起動前準備", "type": "checklist", "category": "復旧確認", "item": "部品交換、清掃、配線修正等の作業内容を記録・確認した", "item_id": "6_0", "linked_item_id": null },
            { "phase": 6, "phase_title": "Phase 4: 再起動前準備", "type": "checklist", "category": "復旧確認", "item": "全ての配線端子が規定トルクで締め付けられていることを確認した", "item_id": "6_1", "linked_item_id": null },
            { "phase": 6, "phase_title": "Phase 4: 再起動前準備", "type": "checklist", "category": "復旧確認", "item": "インバーターのパラメータが、機器の仕様（モーター定格等）に対して正しく設定されていることを確認した", "item_id": "6_2", "linked_item_id": null },
            { "phase": 6, "phase_title": "Phase 4: 再起動前準備", "type": "checklist", "category": "安全確認", "item": "ロックアウト/タグアウトを所定の手順に従い解除した", "item_id": "6_3", "linked_item_id": null },
            { "phase": 6, "phase_title": "Phase 4: 再起動前準備", "type": "checklist", "category": "安全確認", "item": "作業エリアの工具、資材等を撤去し、盤のカバーを確実に取り付けた", "item_id": "6_4", "linked_item_id": null },
            { "phase": 6, "phase_title": "Phase 4: 再起動前準備", "type": "checklist", "category": "絶縁確認", "item": "インバーターの出力端子（U, V, W）を切り離した状態で、モーターと動力ケーブルの絶縁抵抗が良好であることを再確認した", "item_id": "6_5", "linked_item_id": null },
            { "phase": 6, "phase_title": "Phase 4: 再起動前準備", "type": "checklist", "category": "電源投入", "item": "インバーターの制御電源および主回路電源を投入した", "item_id": "6_6", "linked_item_id": null },
            { "phase": 6, "phase_title": "Phase 4: 再起動前準備", "type": "checklist", "category": "電源投入", "item": "操作パネルが正常に表示され、エラーが出ていないことを確認した", "item_id": "6_7", "linked_item_id": null },
            { "phase": 6, "phase_title": "Phase 4: 再起動前準備", "type": "checklist", "category": "最終確認", "item": "オペレーターとメンテナンス担当者で、復旧内容と試運転計画を共有し、異常時の連絡体制を再確認した", "item_id": "6_8", "linked_item_id": null },
            { "phase": 7, "phase_title": "Phase 5: 試運転・正規運転", "type": "checklist", "category": "無負荷運転（モーター単体）", "item": "インバーターの出力端子にモーターのみを接続し、低速（5～10Hz程度）で運転を開始する", "item_id": "7_0", "linked_item_id": null },
            { "phase": 7, "phase_title": "Phase 5: 試運転・正規運転", "type": "checklist", "category": "無負荷運転（モーター単体）", "item": "異音、異常振動がないことを確認しながら、徐々に周波数を定格まで上げていく", "item_id": "7_1", "linked_item_id": null },
            { "phase": 7, "phase_title": "Phase 5: 試運転・正規運転", "type": "checklist", "category": "無負荷運転（モーター単体）", "item": "各周波数での出力電流が、無負荷電流として妥当な値であることをモニターで確認する", "item_id": "7_2", "linked_item_id": null },
            { "phase": 7, "phase_title": "Phase 5: 試運転・正規運転", "type": "checklist", "category": "負荷接続・寸動運転", "item": "電源を遮断し、モーターと負荷機械を接続する", "item_id": "7_3", "linked_item_id": null },
            { "phase": 7, "phase_title": "Phase 5: 試運転・正規運転", "type": "checklist", "category": "負荷接続・寸動運転", "item": "再度電源を投入し、寸動（ジョグ）運転で、負荷がスムーズに動作することを確認する", "item_id": "7_4", "linked_item_id": null },
            { "phase": 7, "phase_title": "Phase 5: 試運転・正規運転", "type": "checklist", "category": "低速での負荷運転", "item": "低速で連続運転を開始し、モーターと負荷機械の動作を監視する", "item_id": "7_5", "linked_item_id": null },
            { "phase": 7, "phase_title": "Phase 5: 試運転・正規運転", "type": "checklist", "category": "低速での負荷運転", "item": "インバーターのモニターで、出力電流値が過大でなく、安定していることを確認する", "item_id": "7_6", "linked_item_id": null },
            { "phase": 7, "phase_title": "Phase 5: 試運転・正規運転", "type": "checklist", "category": "段階的な速度上昇", "item": "運転マニュアルに基づき、段階的に周波数を常用速度まで上昇させる", "item_id": "7_7", "linked_item_id": null },
            { "phase": 7, "phase_title": "Phase 5: 試運転・正規運転", "type": "checklist", "category": "段階的な速度上昇", "item": "各段階で、過電流や過熱等のアラームが発生しないこと、振動や騒音が許容範囲内であることを確認する", "item_id": "7_8", "linked_item_id": null },
            { "phase": 7, "phase_title": "Phase 5: 試運転・正規運転", "type": "checklist", "category": "正規運転への移行", "item": "常用速度で一定時間運転し、全てのパラメータが安定していることを確認して、オペレーターへ運転を引き継ぐ", "item_id": "7_9", "linked_item_id": null },
            { "phase": 7, "phase_title": "Phase 5: 試運転・正規運転", "type": "checklist", "category": "記録・報告", "item": "一連のトラブル対応（エラーコード、原因、対策、結果）を作業完了報告書としてまとめ、関係者へ報告する", "item_id": "7_10", "linked_item_id": null }
        ];
        
        const PRINT_TRIGGER_PHASE = 3;

        let currentPhase = 1;
        const maxPhase = Math.max(...checklistData.map(item => item.phase));
        let checklistState = {};

        function saveState() {
            sessionStorage.setItem('checklistState', JSON.stringify(checklistState));
            sessionStorage.setItem('currentPhase', currentPhase);
        }

        function loadState() {
            const savedState = sessionStorage.getItem('checklistState');
            const savedPhase = sessionStorage.getItem('currentPhase');
            if (savedState) checklistState = JSON.parse(savedState);
            if (savedPhase) currentPhase = parseInt(savedPhase, 10);
        }

        function renderCurrentPhase() {
            const container = $('#checklist-container');
            container.empty();
            let itemsToShow = checklistData.filter(item => item.phase === currentPhase);
            const phaseTitle = itemsToShow.length > 0 ? itemsToShow[0].phase_title : `Phase ${currentPhase}`;

            if (currentPhase === 3 || currentPhase === 5) {
                itemsToShow = itemsToShow.filter(item => checklistState[item.linked_item_id] === 'problem');
            }

            container.append(`<h2 class="phase-title">${phaseTitle}</h2>`);
            if (itemsToShow.length === 0) {
                container.append('<p>このフェーズで表示する項目はありません。前のフェーズで「問題あり」と選択された項目がありませんでした。</p>');
            } else {
                const groupedItems = itemsToShow.reduce((acc, item) => {
                    (acc[item.category] = acc[item.category] || []).push(item);
                    return acc;
                }, {});
                for (const category in groupedItems) {
                    container.append(`<h3 class="category-title">${category}</h3>`);
                    groupedItems[category].forEach(item => container.append(createItemHtml(item)));
                }
            }
            updateButtonVisibility();
            restoreState();
        }

        function createItemHtml(item) {
            const { type, item_id, item: itemText, phase } = item;
            let interactiveElementHtml = '';
            const buttonStyle = 'style="min-width: 95px;"';

            if (type === 'checklist') {
                interactiveElementHtml = `<div class="btn-group-toggle" data-toggle="buttons"><label class="btn btn-outline-primary" ${buttonStyle} data-item-id="${item_id}" data-value="checked"><input type="checkbox" autocomplete="off"> 実施済み</label></div>`;
            } else if (type === 'checklist_with_status') {
                if (phase === 1) {
                    interactiveElementHtml = `<div class="btn-group btn-group-toggle" data-toggle="buttons"><label class="btn btn-outline-success" ${buttonStyle} data-item-id="${item_id}" data-value="applicable"><input type="radio" name="options-${item_id}" autocomplete="off"> 該当</label><label class="btn btn-outline-danger" ${buttonStyle} data-item-id="${item_id}" data-value="not_applicable"><input type="radio" name="options-${item_id}" autocomplete="off"> 非該当</label></div>`;
                } else {
                    interactiveElementHtml = `<div class="btn-group btn-group-toggle" data-toggle="buttons"><label class="btn btn-outline-success" ${buttonStyle} data-item-id="${item_id}" data-value="ok"><input type="radio" name="options-${item_id}" autocomplete="off"> 問題なし</label><label class="btn btn-outline-danger" ${buttonStyle} data-item-id="${item_id}" data-value="problem"><input type="radio" name="options-${item_id}" autocomplete="off"> 問題あり</label></div>`;
                }
            } else if (type === 'checklist_with_na') {
                interactiveElementHtml = `<div class="btn-group btn-group-toggle" data-toggle="buttons"><label class="btn btn-outline-primary" ${buttonStyle} data-item-id="${item_id}" data-value="checked"><input type="radio" name="options-${item_id}" autocomplete="off"> 実施済み</label><label class="btn btn-outline-secondary" ${buttonStyle} data-item-id="${item_id}" data-value="not_applicable"><input type="radio" name="options-${item_id}" autocomplete="off"> 非該当</label></div>`;
            } else if (type === 'text_input') {
                const labelHtml = `<label class="col-auto col-form-label pr-3">${itemText}</label>`;
                const textareaHtml = `<div class="col pl-0"><textarea class="form-control" rows="2" data-item-id="${item_id}" placeholder="具体的な内容を入力"></textarea></div>`;
                return `<div class="form-group row no-gutters align-items-center">${labelHtml}${textareaHtml}</div>`;
            }
            return `<div class="checklist-item-row"><label class="form-check-label item-label">${itemText}</label>${interactiveElementHtml}</div>`;
        }
        
        function restoreState() {
            for (const itemId in checklistState) {
                const value = checklistState[itemId];
                const label = $(`label[data-item-id="${itemId}"][data-value="${value}"]`);
                if (label.length) label.addClass('active').find('input').prop('checked', true);
                const textInput = $(`textarea[data-item-id="${itemId}"]`);
                if (textInput.length) textInput.val(value);
            }
            validateCurrentPhaseCompletion();
            updatePrintButtonVisibility();
        }

        function validateCurrentPhaseCompletion() {
            const requiredItems = checklistData.filter(item => {
                const isCurrentPhase = item.phase === currentPhase && item.type !== 'text_input';
                if (!isCurrentPhase) return false;
                if (currentPhase === 3 || currentPhase === 5) {
                    return $(`label.btn[data-item-id="${item.item_id}"]`).length > 0;
                }
                return true;
            });
            if (requiredItems.length === 0) {
                if (currentPhase < maxPhase) $('#next-btn').prop('disabled', false);
                return;
            }
            const allChecked = requiredItems.every(item => $(`label.btn[data-item-id="${item.item_id}"].active`).length > 0);
            if (currentPhase < maxPhase) $('#next-btn').prop('disabled', !allChecked);
        }

        function updatePrintButtonVisibility() {
            const requiredTriggerPhaseItems = checklistData.filter(item => 
                item.phase === PRINT_TRIGGER_PHASE && ( (item.linked_item_id && checklistState[item.linked_item_id] === 'problem') || !item.linked_item_id )
            );
            if (requiredTriggerPhaseItems.length === 0 && checklistData.some(i => i.phase === PRINT_TRIGGER_PHASE)) {
                 $('#print-btn').hide();
                 return;
            }
            const allTriggerPhaseItemsChecked = requiredTriggerPhaseItems.every(item => checklistState.hasOwnProperty(item.item_id));
            if (allTriggerPhaseItemsChecked) $('#print-btn').show();
            else $('#print-btn').hide();
        }

        function updateButtonVisibility() {
            $('#prev-btn').toggle(currentPhase > 1);
            $('#next-btn').toggle(currentPhase < maxPhase);
            if (currentPhase < maxPhase) $('#next-btn').prop('disabled', true);
        }

        $(document).ready(function() {
            loadState();
            renderCurrentPhase();
            $('#next-btn, #prev-btn').on('click', function() {
                if ($(this).is('#next-btn')) {
                    if ($(this).is(':disabled')) return;
                    if (currentPhase < maxPhase) currentPhase++;
                } else {
                    if (currentPhase > 1) currentPhase--;
                }
                saveState();
                renderCurrentPhase();
            });
            $('#exit-btn').on('click', () => {
                if (confirm('チェックリストを終了し、メインメニューに戻りますか？')) {
                    sessionStorage.clear();
                    window.location.href = 'index.html';
                }
            });
            $('#print-btn').on('click', function() {
                const printContainer = $('#print-area');
                let html = `<h1>「${document.title.replace('異常対応チェックリスト', '')}」実施結果</h1>`;
                const valueMap = { 'checked': '実施済み', 'applicable': '該当', 'not_applicable': '非該当', 'ok': '問題なし', 'problem': '問題あり' };
                const answeredPhaseNumbers = [...new Set(Object.keys(checklistState).map(itemId => checklistData.find(d => d.item_id === itemId)?.phase).filter(p => p).sort((a, b) => a - b))];

                answeredPhaseNumbers.forEach(phaseNum => {
                    const phaseItems = checklistData.filter(d => d.phase === phaseNum && checklistState.hasOwnProperty(d.item_id));
                    if (phaseItems.length > 0) {
                        const printableItems = phaseItems.filter(item => {
                            if (item.linked_item_id) { return checklistState[item.linked_item_id] === 'problem'; }
                            return true;
                        });
                        if (printableItems.length > 0) {
                            html += `<h2>${printableItems[0].phase_title}</h2><table class="print-table"><tr><th>項目</th><th>結果</th></tr>`;
                            printableItems.forEach(item => {
                                let result = checklistState[item.item_id];
                                let resultText = valueMap[result] || result;
                                let style = (result === 'problem') ? 'style="color: red;"' : '';
                                html += `<tr><td>${item.item}</td><td ${style}>${resultText}</td></tr>`;
                            });
                            html += '</table>';
                        }
                    }
                });
                printContainer.html(html);
                window.print();
            });
            $('#checklist-container').on('click', 'label.btn', function() {
                const label = $(this), itemId = label.data('item-id'), isRadio = label.find('input').is('[type="radio"]');
                setTimeout(() => {
                    if (isRadio) {
                         const activeValue = label.closest('.btn-group-toggle').find('.active').data('value');
                         if(activeValue) checklistState[itemId] = activeValue; else delete checklistState[itemId];
                    } else {
                        if (label.hasClass('active')) checklistState[itemId] = label.data('value'); else delete checklistState[itemId];
                    }
                    saveState();
                    validateCurrentPhaseCompletion();
                    updatePrintButtonVisibility();
                }, 0);
            });
            $('#checklist-container').on('input', 'textarea', function() {
                const input = $(this), itemId = input.data('item-id'), value = input.val();
                if (value) checklistState[itemId] = value; else delete checklistState[itemId];
                saveState();
            });
        });
    </script>
</body>
</html>